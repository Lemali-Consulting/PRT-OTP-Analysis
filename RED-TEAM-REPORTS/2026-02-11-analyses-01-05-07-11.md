# Red-Team Report: Analyses 01–05, 07–11

**Date:** 2026-02-11
**Reviewer:** Claude (model-assisted, checklist-based protocol)
**Status:** Report only — no code changes made
**Protocol:** [docs/RED-TEAM.md](../docs/RED-TEAM.md)

---

## Summary

61 findings across 10 analyses. 8 significant, 20 moderate, 33 low. No code changes have been made — this report is for human review and selective approval.

**Cross-cutting themes:**
1. **Mode stratification missing** in 6 of 10 analyses (01, 02, 04, 05, 08, 03). Bus and rail are pooled without a bus-only check.
2. **No minimum-month filter** in 6 analyses (01, 03, 04, 07, 08, 10, 11). Routes with 1–2 months of data are weighted equally to those with 70+.
3. **Static `trips_7d` / `route_stops` snapshot** used as if it represents all time periods. Inherent to the data — no fix available, but under-documented.
4. **METHODS.md drift** — several analyses evolved past what METHODS.md describes (10, 11 say SUM but code uses MAX; 01 references unused `routes` table; 03 doesn't specify post-COVID restriction).

---

## Analysis 01 — System-Wide OTP Trend

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | B | **Significant** | main.py:15-24 | Bus and rail pooled in system-wide averages with no stratification. Rail (~84% OTP) inflates system average. | SQL references only `otp_monthly` with no mode filter. All 98 routes across BUS, RAIL, UNKNOWN included. | Add a bus-only trend line or note that the system average includes structurally higher-performing rail. |
| 2 | F | Moderate | METHODS.md:15 | METHODS.md lists `routes` table under Data ("mode filter (BUS only vs. all modes)") but code never uses `routes` and applies no mode filter. | main.py has no JOIN to `routes` and no WHERE clause on `mode`. | Remove `routes` bullet from METHODS.md or implement the stratification it implies. |
| 3 | E | Moderate | main.py:29-38 | Route count varies 68–96 across months. Unweighted mean treats all months equally regardless of which routes are present. Nov 2020 has only 68 routes. | Database: `COUNT(DISTINCT route_id)` per month ranges from 68 to 96. No balanced-panel restriction. | Restrict to balanced panel or flag imbalanced months. |
| 4 | F | Low | FINDINGS.md:18 | Claims "route count has been stable at 93" but data shows 68–96 range. | `route_count` column in output CSV shows variation. | Correct the statement. |
| 5 | G | Low | main.py:17 | 5 routes not in `route_stops` (37, 42, P2, RLSH, SWL) get `trips_7d=0` via COALESCE, excluding them from weighted average. P2 has 57 months of ~84% OTP. Undocumented. | COALESCE at line 17. Routes confirmed missing from `route_stops`. | Document which routes are excluded and why. |

**Passed cleanly:** A, C, D, H.

---

## Analysis 02 — Mode Comparison

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | C | **Significant** | FINDINGS.md:5 | "Light rail **significantly outperforms bus**" — uses "significantly" without any formal test. Only 3 rail routes; no t-test, Mann-Whitney, or CI computed. | main.py:39 computes `pl.col("otp").mean()` per mode per month. No test statistic anywhere. | Add a formal test or rephrase to avoid implying statistical significance. |
| 2 | C | Moderate | main.py:60-74, FINDINGS.md:17 | Paired route comparison reports "+3.5 pp" with no CI, t-test, or p-value. Only 2 pairs (51/51L, 53/53L). | main.py:70 computes `otp_diff` but no test applied. | Add paired t-test or CIs. Acknowledge n=2. |
| 3 | G | Moderate | main.py:20-24 | 5 UNKNOWN-mode routes (including P2 "East Busway Short" with 57 months) are included in data but silently dropped from chart. P2 is plausibly BUS. | main.py:92 only iterates BUS, RAIL, INCLINE. | Reclassify P2 or explicitly exclude UNKNOWN with documentation. |
| 4 | F | Moderate | METHODS.md:8, common.py:62-72 | `classify_bus_route()` classifies all P-prefix as "busway" and O-prefix as "flyer." P17, P78, G31, G3 are actually flyers, not busway. | common.py:68: `if route_id.startswith(("P", "G")): return "busway"`. Database shows P17="LINCOLN PARK FLYER". | Refine classification or update METHODS.md to match actual behavior. |
| 5 | B | Low | main.py:37-40 | Unweighted mode average treats a route with 5 trips/week the same as 500. | `avg_otp=pl.col("otp").mean()` — no trip weighting. | Consider trip-weighted mode average. |
| 6 | E | Low | main.py:37-49 | Route composition varies by month (68–96). No balanced-panel filter. | Same data as Analysis 01. | Apply balanced-panel filter or document. |

**Passed cleanly:** A, D, H.

---

## Analysis 03 — Route Ranking

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | D | **Significant** | main.py:46-53, FINDINGS.md:27-41 | Top/bottom and most-improving/declining lists identify extreme performers with no RTM adjustment or shrinkage. Extreme observations regress toward the mean. | FINDINGS.md:41: "G2 has improved markedly" — comparing all-time 81.7% to recent 88.4%. No RTM caveat. | Apply empirical Bayes shrinkage or add RTM caveat. |
| 2 | C | Moderate | main.py:62-76 | Post-COVID slopes are OLS point estimates with no standard errors, CIs, or p-values. Slopes of +6.6 or -10.5 pp/year could be insignificant. | main.py:65-69 computes slope via cov/var. No residual variance or t-statistic. | Compute slope SEs and CIs. Filter or flag insignificant slopes. |
| 3 | E | Moderate | main.py:57-60 | Post-COVID slope period starts 2022-01, but routes have different observation spans. A route with 12 months in 2024–2025 gets a slope over a narrower window than one with 47 months. `MIN_MONTHS=12` checks count, not span. | main.py:74 filters `slope_months >= MIN_MONTHS` but doesn't check coverage. | Require observations across the full window, or normalize by actual span. |
| 4 | B | Moderate | main.py:34-43, FINDINGS.md:9-15 | Rankings pool all modes. Rail routes (~84% OTP) compete in the same ranking as bus (~63%), conflating structural mode advantage with route performance. | Rankings at lines 96-100 computed across all modes together. | Stratify rankings by mode or add within-mode rank. |
| 5 | H | Moderate | main.py:63-69 | If `time_idx` variance is zero (all observations in same month), slope computation divides by zero. `MIN_MONTHS=12` makes this unlikely but not impossible with duplicate data. | main.py:69: `/ pl.col("time_idx").var(ddof=0)` — no guard. | Add zero-variance guard. |
| 6 | F | Low | METHODS.md:8 | Says "Fit a simple linear slope (OTP vs. time) per route" without specifying the post-2022 restriction. | Code uses `POST_COVID_START = "2022-01"` at line 13. | Update METHODS.md. |
| 7 | G | Low | main.py:18-28 | 5 routes (37, 42, P2, RLSH, SWL) have null `stop_count` from LEFT JOIN. Undocumented. | main.py:81 uses `how="left"`. | Document or filter. |

**Passed cleanly:** A, G (joins correct).

---

## Analysis 04 — Neighborhood Equity

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | A | **Significant** | main.py:15-25, 31-40 | Weighted OTP pools across all months with static `trips_7d`. A route with 83 months contributes 83x more trip-weight than one with 1 month, even at identical `trips_7d`. | SQL cross-joins every route-stop-direction row with every month for that route. Routes range 2–83 months. | Aggregate OTP to route level first, then weight by `trips_7d`. Or compute weighted avg per month, then average across months. |
| 2 | A | Moderate | main.py:15-25 | One route-stop pair (route 57, stop S04160) appears in two directions, double-counting its `trips_7d`. | Database confirms `('57', 'S04160', 2)` direction rows. No pre-aggregation to unique (route_id, stop_id). | Pre-aggregate `route_stops` to unique (route_id, stop_id). Negligible impact (1 pair). |
| 3 | G | Moderate | main.py:16 | 18 `route_stops` rows have `trips_7d IS NULL`. Silently dropped from weighted formula by Polars null-skipping, but may still count in `stop_count` and `route_count`. | Database confirms 18 nulls. No `WHERE trips_7d IS NOT NULL` filter. | Add explicit null filter or document. |
| 4 | B | Moderate | main.py:15-25 | Bus and rail pooled without stratification. Rail routes have systematically higher OTP and could drive "best neighborhood" rankings via Simpson's paradox. | FINDINGS.md:45 acknowledges rail advantage qualitatively but no bus-only analysis is performed. | Add bus-only stratification check. |
| 5 | E | Moderate | main.py:57-61 | Quintile time series computed over unbalanced panel. A neighborhood gaining or losing a route shows OTP changes from composition, not performance. | Route month counts range 2–83. No balanced-panel restriction. | Restrict time series to balanced panel or document risk. |
| 6 | C | Low | FINDINGS.md:5-6 | "25 pp spread" between best/worst neighborhoods has no CI or formal test. Neighborhoods have 2–16 routes each. | No hypothesis test or CI provided. | Add bootstrap CIs or note sample-size caveat. |
| 7 | F | Low | METHODS.md:9-10 | Describes weighted OTP as "average trip experience" but code computes time-pooled weighted average across all months — a different quantity. | METHODS.md framing vs. main.py:34 computation. | Clarify METHODS.md. |

**Passed cleanly:** D, H.

---

## Analysis 05 — Anomaly Investigation

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | H | **Significant** | main.py:39-52 | Division by zero when `rolling_std` is 0 (constant OTP in a rolling window). Produces `inf` z-scores that pass the `abs() > 2.0` threshold, creating false anomalies. | main.py:52: `(pl.col("otp") - pl.col("rolling_mean")) / pl.col("rolling_std")`. A 6–12 month window with constant OTP yields std=0. | Set z-score to 0 or null when `rolling_std < epsilon`. |
| 2 | B | Moderate | main.py:26-31, FINDINGS.md:30 | Bus and rail pooled. FINDINGS.md notes rail routes trigger many anomalies despite high OTP because their normally-consistent performance makes even small dips register as 2-sigma. | FINDINGS.md:30 describes the differential behavior by mode. No mode-stratified analysis. | Present separate anomaly rates by mode or use mode-specific thresholds. |
| 3 | C | Moderate | main.py:19, 54-56 | Z-threshold of 2.0 across ~7,651 observations expects ~350 false positives under normality. 842 flagged (2.4x null). No comparison to null expectation or multiple-comparison correction. | main.py:19: `Z_THRESHOLD = 2.0`. FINDINGS.md:5: 842 anomalies. | Report expected false-positive count under null, or apply FDR correction. |
| 4 | D | Moderate | main.py:38-48 | Lagged rolling window biases z-scores for trending routes. If OTP is declining, baseline is always above current, making negative anomalies more likely. FINDINGS.md:29 acknowledges this but no alternative is tested. | Shift-1 approach means baseline is always stale for trending series. | Consider detrending or quantify trend-induced false-positive rate. |
| 5 | E | Low | main.py:39-48 | Routes with <7 months silently excluded (shift + min_samples=6). Routes 37, 42, 53, RLSH (2–3 months) never flagged, not documented as excluded. | MIN_PERIODS=6 plus shift(1) requires 7 months. | Document excluded routes. |
| 6 | F | Low | METHODS.md:3 | Question asks about "sharp OTP drops" (one-sided) but code flags both drops and spikes (`z_score.abs()`). | main.py:55: `pl.col("z_score").abs() > Z_THRESHOLD`. | Align METHODS.md with two-sided implementation. |
| 7 | G | Low | main.py:26-31 | 5 UNKNOWN-mode routes included without documentation. | No WHERE clause on mode. | Filter or document. |

**Passed cleanly:** A.

---

## Analysis 07 — Stop Count vs OTP

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | A | Moderate | main.py:16-28 | Stop count from current `route_stops` snapshot paired with OTP averaged across all historical months. Routes that changed stop configurations have a mismatch. | COUNT(DISTINCT stop_id) from current data joined to AVG(otp) from 2019–2025. FINDINGS.md:30 acknowledges this. | Acknowledge more prominently in METHODS.md or restrict OTP to recent months. |
| 2 | E | Moderate | main.py:21-27 | No minimum-month filter. `months` column computed but never used for filtering. A route with 1 month weighted equally to one with 70+. | main.py:23: `COUNT(*) AS months` selected but no HAVING clause. | Add `HAVING COUNT(*) >= 12`. |
| 3 | B | Low | main.py:36-48 | Bus-only stratification properly implemented, but total N for all-routes correlation not stored in results. | `results["bus_n"]` tracked but no `all_n`. FINDINGS.md reports both Ns correctly. | Store and report `all_n`. |
| 4 | F | Low | METHODS.md:10-11 | Says "Compute Pearson correlation coefficient" (singular). Code computes Pearson (all + bus) and Spearman (bus). | Code lines 36-47. | Update METHODS.md. |
| 5 | H | Low | main.py:75-83 | Manual regression line uses population variance (`/n`) instead of sample (`/n-1`). Cosmetic — not used for inference. | main.py:77-79. | Use `scipy.stats.linregress`. |
| 6 | H | Low | main.py:42 | No `len(bus) >= 2` guard before `pearsonr`. In practice n=90. | Lines 42-43. | Add guard. |

**Passed cleanly:** C (tests present), D (not applicable).

---

## Analysis 08 — Hot-Spot Map

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | A | **Significant** | main.py:16-29, 37 | "Stop-level OTP" is route-level OTP projected onto geography via `trips_7d` weighting. A stop served by one route inherits that route's OTP entirely. FINDINGS.md confirms: "worst stops are exclusively served by Route 77." | main.py:37: `(avg_otp * trips_7d).sum() / trips_7d.sum()`. | Rename to "route-weighted OTP at stop" and document that this is a derived metric, not independently measured. |
| 2 | B | Moderate | main.py:16-29 | Bus and rail pooled. Map shows rail stops as green (high OTP) and bus as varying, but no separate analysis produced. | No mode filter in SQL. No bus-only map. | Add mode column; optionally produce bus-only map. |
| 3 | E | Moderate | main.py:21-24 | No minimum-month filter on route-level `avg_otp`. Sparse routes spread across potentially hundreds of stops. | `AVG(otp) ... GROUP BY route_id` — no HAVING clause. | Add minimum-months threshold. |
| 4 | F | Moderate | main.py:66 | "System average" in chart title is unweighted mean of per-stop OTP, treating every stop equally regardless of trip volume. | `system_avg = sum(otp) / len(otp)`. | Weight by `total_trips_7d` or clarify it's unweighted. |
| 5 | F | Low | FINDINGS.md:22 | Says NaN OTP stops "were included in the map" but code filters them out at lines 41 and 163. | main.py:41: `.filter(is_not_null())`. Line 163: `.filter(is_not_nan())`. | Correct FINDINGS.md. |
| 6 | G | Low | main.py:236 | Console printout checks `row["hood"] or "N/A"` but doesn't check for sentinel `"0"`. Interactive map at line 166 does check. | Compare line 236 vs. line 166. | Add `!= "0"` check. |
| 7 | H | Low | main.py:37 | If all routes at a stop have `trips_7d=0`, weighted OTP divides by zero → NaN. Filter at line 41 catches it silently. No count of dropped stops logged. | `trips_7d.sum()` could be 0. | Log number of stops dropped. |

**Passed cleanly:** C (descriptive, not hypothesis-testing), D.

---

## Analysis 09 — Incline Investigation

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | F | Low | FINDINGS.md:19, main.py:22-24 | Claims "Both MI and DQI exist in routes table" but OTP queries (line 33) only check `route_id = 'MI'`, not DQI explicitly. DQI finding relies on `mode = 'INCLINE'` catching it. | main.py:33-35 queries only MI. | Query `WHERE route_id IN ('MI', 'DQI')` to substantiate claim. |
| 2 | F | Low | METHODS.md:2-3 | Question says "has zero/null values" but the actual finding is "no rows at all." Outdated assumption not updated. | FINDINGS.md:22 corrects: "no values at all, not even zeros." | Update METHODS.md question. |
| 3 | G | Low | main.py:46-49 | LEFT JOIN on stops is correct for this investigation. No issues — noted for completeness. | — | No fix needed. |

**Passed cleanly:** A, B, C, D, E, H. This is a data-quality audit, not a statistical analysis — most categories are not applicable.

---

## Analysis 10 — Trip Frequency vs OTP

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | A | **Significant** | METHODS.md:8, main.py:16-20 | METHODS.md says "sum of `trips_wd` across all stops" but code computes `MAX(trips_wd)`. FINDINGS.md correctly notes MAX, but METHODS.md was never updated. | METHODS.md:8 vs. main.py:18: `MAX(trips_wd) AS max_trips_wd`. | Update METHODS.md. |
| 2 | F | Moderate | METHODS.md:10, main.py:36-47 | METHODS.md says "Compute Pearson correlation" (singular) but code computes three correlations (all-Pearson, bus-Pearson, bus-Spearman). | Code lines 36-47. | Update METHODS.md. |
| 3 | E | Moderate | main.py:16-27 | No minimum-month filter. Static `MAX(trips_wd)` paired with `AVG(otp)` across all historical months. Route with 1 month weighted equally to 70+. | No HAVING clause. | Add `HAVING COUNT(*) >= N`. |
| 4 | C | Low | main.py:36-47 | Three correlation tests with no multiple-comparison correction. All non-significant, so correction wouldn't change conclusions. | Lines 36, 42, 43. | Note in FINDINGS.md or apply correction. |
| 5 | G | Low | main.py:16-20 | No filter for `trips_wd IS NULL`. `MAX()` skips nulls, but a route with all-null stops produces NULL. | No WHERE clause. | Add null filter. |
| 6 | H | Low | main.py:74-77 | Manual regression uses population variance (`/n`). Cosmetic. | Line 77: `/ n`. | Use `linregress`. |

**Passed cleanly:** B (bus-only stratification implemented), D.

---

## Analysis 11 — Directional Asymmetry

| # | Category | Severity | File:Line | Issue | Evidence | Suggested Fix |
|---|----------|----------|-----------|-------|----------|---------------|
| 1 | F | **Significant** | METHODS.md:11, main.py:18-30 | METHODS.md says "Exclude stops with combined `IB,OB` direction." Code does the opposite — includes IB,OB in both directions. FINDINGS.md correctly describes the actual behavior. | METHODS.md:11 vs. main.py:22,27: `WHERE direction IN ('IB', 'IB,OB')` and `('OB', 'IB,OB')`. | Update METHODS.md to match code. |
| 2 | A | Moderate | main.py:18-30 | Including IB,OB stops in both IB and OB MAX computations means that if an IB,OB stop has the highest `trips_wd`, both directions report the same MAX, mechanically forcing asymmetry toward zero. | Lines 22, 27 both include 'IB,OB'. FINDINGS.md reports max asymmetry of only 0.077. | Acknowledge limitation or compute from pure IB/OB stops only. |
| 3 | F | Moderate | METHODS.md:7-8, main.py:18-30 | METHODS.md says "compute total IB trips and OB trips" (sum). Code computes `MAX(trips_wd)`. | METHODS.md:7 vs. main.py:19. | Update METHODS.md. |
| 4 | E | Moderate | main.py:31-37, 70 | No minimum-month filter. Static asymmetry index paired with historical OTP average. | No HAVING clause. | Add minimum-month filter. |
| 5 | C | Low | main.py:76-95 | Three correlations with no multiple-comparison correction. All non-significant. | Lines 76-77, 86-87, 89-90. | Note or apply correction. |
| 6 | G | Low | main.py:18-30 | No `trips_wd IS NOT NULL` filter. Routes with all-null stops could produce null MAX. | No WHERE clause. | Add null filter. |
| 7 | H | Low | main.py:126 | Manual regression uses population variance. Cosmetic. | Line 126. | Use `linregress`. |

**Passed cleanly:** B (bus-only stratification implemented), D.

---

## Severity Tally

| Analysis | Significant | Moderate | Low | Total |
|----------|-------------|----------|-----|-------|
| 01 — System Trend | 1 | 2 | 2 | 5 |
| 02 — Mode Comparison | 1 | 3 | 2 | 6 |
| 03 — Route Ranking | 1 | 4 | 2 | 7 |
| 04 — Neighborhood Equity | 1 | 4 | 2 | 7 |
| 05 — Anomaly Investigation | 1 | 3 | 3 | 7 |
| 07 — Stop Count vs OTP | 0 | 2 | 4 | 6 |
| 08 — Hot-Spot Map | 1 | 3 | 3 | 7 |
| 09 — Incline Investigation | 0 | 0 | 3 | 3 |
| 10 — Frequency vs OTP | 1 | 2 | 3 | 6 |
| 11 — Directional Asymmetry | 1 | 3 | 3 | 7 |
| **Total** | **8** | **26** | **27** | **61** |

---

## Recommended Priority

**Fix first (Significant, likely to change findings):**
1. Analysis 04 #1 — time-pooled weighting inflates long-history routes
2. Analysis 05 #1 — division by zero produces false anomalies
3. Analysis 08 #1 — rename/document that "stop OTP" is a derived metric

**Fix second (Significant, documentation/framing):**
4. Analysis 01 #1 — add bus-only trend line
5. Analysis 02 #1 — remove "significantly" or add formal test
6. Analysis 03 #1 — add RTM caveat to extreme rankings
7. Analysis 10 #1 — update METHODS.md (SUM → MAX)
8. Analysis 11 #1 — update METHODS.md (exclude → include IB,OB)

**Batch fix (recurring Moderate patterns):**
- Add `HAVING COUNT(*) >= 12` to analyses 01, 03, 04, 07, 08, 10, 11
- Add bus-only stratification to analyses 01, 04, 05
- Update stale METHODS.md across 01, 02, 03, 05, 07, 10, 11

**Accept as-is (Low):**
- Population-variance trendlines (cosmetic, 07/10/11)
- Multiple-comparison notes (all results already non-significant)
- Minor null-handling edge cases
